name: Release (Fork)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. 0.5.1 or v0.5.1). Required if not running on a tag.'
        required: false
      prerelease:
        description: 'Mark the release as a prerelease'
        required: false
        default: 'false'

permissions:
  contents: write

concurrency:
  group: release-fork-${{ github.ref }}
  cancel-in-progress: false

jobs:
  resolve:
    name: Resolve version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.resolve.outputs.version }}
      tag: ${{ steps.resolve.outputs.tag }}
      prerelease: ${{ steps.resolve.outputs.prerelease }}
      should_tag: ${{ steps.resolve.outputs.should_tag }}
    steps:
      - name: Resolve version
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          input_version="${{ inputs.version || '' }}"
          prerelease_input="${{ inputs.prerelease || 'false' }}"
          ref_name="${GITHUB_REF_NAME:-}"

          if [[ "${GITHUB_REF_TYPE:-}" == "tag" && "$ref_name" == v* ]]; then
            raw_version="$ref_name"
          else
            raw_version="$input_version"
          fi

          raw_version="${raw_version#v}"
          if [[ -z "$raw_version" ]]; then
            echo "version is required when not running from a v* tag" >&2
            exit 1
          fi

          tag="v${raw_version}"
          should_tag="false"
          if [[ "${GITHUB_REF_TYPE:-}" != "tag" ]]; then
            should_tag="true"
          fi

          echo "version=$raw_version" >> "$GITHUB_OUTPUT"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "prerelease=$prerelease_input" >> "$GITHUB_OUTPUT"
          echo "should_tag=$should_tag" >> "$GITHUB_OUTPUT"

  build:
    name: Build ${{ matrix.target }}
    needs: [resolve]
    runs-on: ${{ matrix.os }}
    env:
      RUST_WORKSPACE_DIR: code-rs
      CODE_VERSION: ${{ needs.resolve.outputs.version }}
      CARGO_TARGET_DIR: ${{ github.workspace }}/code-rs/target
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            target: x86_64-unknown-linux-musl
            artifact: code-x86_64-unknown-linux-musl
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-musl
            artifact: code-aarch64-unknown-linux-musl
          - os: macos-14
            target: x86_64-apple-darwin
            artifact: code-x86_64-apple-darwin
          - os: macos-14
            target: aarch64-apple-darwin
            artifact: code-aarch64-apple-darwin

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build WebUI assets
        shell: bash
        run: |
          set -euo pipefail
          cd code-rs/webui
          npm install
          npm run build

      - name: Install Rust toolchain
        shell: bash
        env:
          RUST_TOOLCHAIN: 1.90.0
        run: |
          rustup set profile minimal
          rustup toolchain install "$RUST_TOOLCHAIN" --profile minimal
          rustup default "$RUST_TOOLCHAIN"
          rustup target add "${{ matrix.target }}"

      - name: Linux musl tuning
        if: contains(matrix.os, 'ubuntu') && contains(matrix.target, 'musl')
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools pkg-config zstd
          echo 'CC=musl-gcc' >> "$GITHUB_ENV"
          case "${{ matrix.target }}" in
            x86_64-unknown-linux-musl) echo 'CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_LINKER=musl-gcc' >> "$GITHUB_ENV" ;;
            aarch64-unknown-linux-musl) echo 'CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER=musl-gcc' >> "$GITHUB_ENV" ;;
          esac
          echo 'PKG_CONFIG_ALLOW_CROSS=1' >> "$GITHUB_ENV"
          echo 'OPENSSL_STATIC=1'         >> "$GITHUB_ENV"
          echo 'RUSTFLAGS=-Awarnings -C debuginfo=0 -C strip=symbols -C panic=abort' >> "$GITHUB_ENV"

      - name: macOS tuning
        if: startsWith(matrix.os, 'macos-')
        shell: bash
        run: |
          echo 'RUSTFLAGS=-Awarnings -C debuginfo=0 -C strip=symbols -C panic=abort' >> "$GITHUB_ENV"


      - name: Prefetch deps
        working-directory: ${{ env.RUST_WORKSPACE_DIR }}
        env:
          CARGO_NET_GIT_FETCH_WITH_CLI: "true"
        run: cargo fetch --locked

      - name: Build code (release)
        shell: bash
        run: |
          cd "${RUST_WORKSPACE_DIR}"
          cargo build --release --locked --target "${{ matrix.target }}" --bin code

      - name: Prepare artifacts
        shell: bash
        run: |
          mkdir -p artifacts
          cp "${RUST_WORKSPACE_DIR}/target/${{ matrix.target }}/release/code" "artifacts/${{ matrix.artifact }}"

      - name: Compress artifacts
        shell: bash
        run: |
          shopt -s nullglob
          for f in artifacts/*; do
            [ -f "$f" ] || continue
            base=$(basename "$f")
            tar -C artifacts -czf "artifacts/${base}.tar.gz" "$base"
            rm -f "$f"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: artifacts/
          compression-level: 0

  release:
    name: Publish release
    needs: [resolve, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create tag (workflow_dispatch)
        if: needs.resolve.outputs.should_tag == 'true'
        env:
          TAG: ${{ needs.resolve.outputs.tag }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          git fetch --tags origin
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists; skipping tag creation."
            exit 0
          fi
          git tag "$TAG" "$GITHUB_SHA"
          git push origin "$TAG"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Add install script
        shell: bash
        run: |
          set -euo pipefail
          cp scripts/install.sh release-assets/install.sh
          chmod +x release-assets/install.sh

      - name: Generate checksums
        shell: bash
        run: |
          set -euo pipefail
          cd release-assets
          if command -v shasum >/dev/null 2>&1; then
            shasum -a 256 * > SHA256SUMS.txt
          else
            sha256sum * > SHA256SUMS.txt
          fi

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.resolve.outputs.tag }}
          name: ${{ needs.resolve.outputs.tag }}
          prerelease: ${{ needs.resolve.outputs.prerelease }}
          files: release-assets/**
